import os
import sys
import json
import re
import requests
import base64
from html import escape
from pprint import pprint
from requests.auth import HTTPBasicAuth
from datetime import datetime

# import json

headers = {
    "Content-Type": "application/json",
}
myProjectID = "42364"
myTestRunID = "39950471"
myContent = """{
    "name": "Demo",
    "automation_content": "sample-demo-api-AutomationTestLog",
    "status": "fail",
    "exe_start_date": "2018-03-21T02:09:11+06:00",
    "exe_end_date": "2018-03-21T02:20:11+06:00",
    "note": "your message note",
    "attachments": [{
        "name": "sample_file_name.txt",
        "content_type": "text/plain",
        "data": "dGhpcyBpcyBzYW1wbGUgdGVzdA=="
    }],

    "test_step_logs": [{
        "description": "step 1 desc",
        "expected_result": "step 1 expected",
        "actual_result": "it is not meet requirement",
        "status": "fail",
        "order": 0
    }, {
        "description": "step 2 desc",
        "expected_result": "step 2 expected",
        "actual_result": "it meets requirement",
        "status": "skip",
        "order": 1
    }]
}"""
toencode = "ocs.autotest@mclaren.com" + ':'
url = "https://mclaren.qtestnet.com/oauth/token"
auth = "Basic " + (base64.b64encode(toencode.encode('utf-8')).decode('utf-8'))
authHeaders = {
    "Content-Type": "application/x-www-form-urlencoded",
    "Authorization": auth
}
body = {
    "grant_type": "password",
    "username": "ocs.autotest@mclaren.com",
    "password": "McL@ren1"
}
myResponse = requests.post(url=url, headers=authHeaders, data=body)
if (myResponse.ok):
    print(myResponse.content)
    str_response = myResponse.content.decode('utf-8')
    response = json.loads(str_response)
    token = "bearer " + response['access_token']
    headers['Authorization'] = token
else:
    myResponse.raise_for_status()
myInstance = "https://mclaren.qtestnet.com"
testStart = datetime.now().isoformat()[:-3] + "Z"
url = myInstance + "/api/v3/projects/" + myProjectID + "/test-runs/" + myTestRunID + "/auto-test-logs"
dbody = json.dumps(myContent)
myResponse = requests.post(url=url, headers=headers, data=myContent)
if (myResponse.ok):
    print(myResponse.content)
else:
    myResponse.raise_for_status()
    
